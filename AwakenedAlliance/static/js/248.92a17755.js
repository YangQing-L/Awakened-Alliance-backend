"use strict";(self["webpackChunkawakened_alliance"]=self["webpackChunkawakened_alliance"]||[]).push([[248],{3389:function(t,e,s){s.d(e,{S:function(){return r}});s(7658);var i=s(7387),a=s.n(i),h=s(1120),l=s(680);const r=t=>{window.refresh_id=-1;const e=()=>{if(!l.Z.get("refresh"))return h.Z.push("/login"),!1;i(),o()},s=()=>{if(!l.Z.get("refresh"))return h.Z.push("/login"),!1;i(),n()},i=()=>{r(),-1!=window.refresh_id&&(clearInterval(window.refresh_id),window.refresh_id=-1),window.refresh_id=setInterval(r,27e4)},r=()=>{a().ajax({url:"https://app4689.acapp.acwing.com.cn:4436/api/token/refresh/",type:"post",data:{refresh:l.Z.get("refresh")},success:t=>{console.log("access刷新成功:",t.access);let e=new Date(1*new Date+27e4);l.Z.set("access",t.access,{expires:e})},error:()=>{console.log("access刷新失败")}})},o=()=>{a().ajax({url:"https://app4689.acapp.acwing.com.cn:4436/settings/getinfo_jwt/",type:"get",data:{platform:t.state.platform},headers:{Authorization:"Bearer "+l.Z.get("access")},success:function(e){"success"===e.result?(t.commit("udpateUsername",e.username),t.commit("updatePhoto",e.photo)):console.log("jwt还未登录")},error:()=>{console.log("jwt登录报错"),h.Z.push("/login")}})},n=()=>{a().ajax({url:"https://app4689.acapp.acwing.com.cn:4436/apply_code/",type:"get",success:function(t){console.log("getinfo_acapp:",t),"success"===t.result&&_.api.oauth2.authorize(t.appid,t.redirect_uri,t.scope,t.state,(t=>{if("success"===t.result){let e=new Date(1*new Date+27e4);l.Z.set("access",t.access,{expires:e}),l.Z.set("refresh",t.refresh,{expires:14.5})}}))}})},_=t.state.AcWingOS;"AcWingOS"===_?e():s()}},7248:function(t,e,s){s.r(e),s.d(e,{default:function(){return ot}});var i=s(3396);const a={class:"playground"},h={ref:"div",class:"game-map-div"},l={ref:"canvas",tabindex:"0"};function r(t,e,s,r,o,n){const _=(0,i.up)("ChatField");return(0,i.wg)(),(0,i.iD)("div",a,[(0,i._)("div",h,[(0,i._)("canvas",l,null,512),(0,i.Wm)(_,{ref:"chat_field_ref"},null,512),(0,i._)("button",{ref:"quit_game_button",onClick:e[0]||(e[0]=e=>t.quit_the_game())}," 退出游戏 ",512)],512)])}s(7658);var o=s(4870);const n=[];class _{constructor(){n.push(this),this.timedelta=0,this.has_called_start=!1,this.uuid=this.create_uuid()}create_uuid(){let t="";for(let e=0;e<20;e++){let e=parseInt(Math.floor(10*Math.random()));t+=e}return t}start(){}update(){}late_update(){}late_late_update(){}player_component_update(){}on_destroy(){}destroy(){this.on_destroy();for(let t in n){const e=n[t];if(e===this){n.splice(t,1);break}}}}let c;const d=t=>{for(let e of n)e.has_called_start?(e.timedelta=t-c,e.update()):(e.start(),e.has_called_start=!0);for(let e of n)e.late_update();for(let e of n)e.late_late_update();for(let e of n)e.player_component_update();c=t,requestAnimationFrame(d)};requestAnimationFrame(d);class u extends _{constructor(t,e,s,i,a,h,l){super(),this.game_map=t,this.playground=e,this.ctx=s,this.i=i,this.j=a,this.cube_side_len=h,this.y=this.i*this.cube_side_len,this.x=this.j*this.cube_side_len,this.character="grid",this.relative_position_x=0,this.relative_position_y=0,this.stroke_color=l,this.is_poisoned=!1,this.base_fill_color=null,this.fill_color=this.base_fill_color}start(){}on_destroy(){for(let t=0;t<this.game_map.grids.length;t++)if(this.game_map.grids[t]===this){this.game_map.grids.splice(t,1);break}}get_manhattan_dist(t,e,s,i){return Math.max(Math.abs(t-s),Math.abs(e-i))}get_dist(t,e,s,i){let a=t-s,h=e-i;return Math.sqrt(a*a+h*h)}update(){let t=this.playground.scale,e=this.playground.my_calculate_relative_position_x(this.x),s=this.playground.my_calculate_relative_position_y(this.y),i=e+.5*this.cube_side_len,a=s+.5*this.cube_side_len;this.playground.is_element_out_of_screen(i,a)||(this.set_player_point_color(),this.set_color(),this.render_grid_stroke(e,s,t),this.render(e,s,t))}set_color(){}set_player_point_color(){if(this.playground.players.length>0){let t=this.playground.players[0];"me"===t.character&&this.get_manhattan_dist(this.x+this.cube_side_len/2,this.y+this.cube_side_len/2,t.x,t.y)<.5*this.cube_side_len?this.fill_color="rgba(56, 93, 56, 0.2)":this.fill_color=this.base_fill_color}}render(t,e,s){}render_grid_stroke(t,e,s){this.ctx.save(),this.ctx.beginPath(),this.ctx.lineWidth=.03*this.cube_side_len*s,this.ctx.strokeStyle=this.stroke_color,this.ctx.rect(t*s,e*s,this.cube_side_len*s,this.cube_side_len*s),this.ctx.stroke(),this.ctx.restore()}render_grass(t,e,s){this.ctx.save(),this.ctx.beginPath(),this.ctx.lineWidth=0,this.ctx.rect(t*s,e*s,this.cube_side_len*s,this.cube_side_len*s),this.ctx.fillStyle=this.grass_color,this.ctx.fill(),this.ctx.restore()}}class p extends u{constructor(t,e,s,i,a,h,l){super(t,e,s,i,a,h,l),this.state="",this.base_fill_color="rgb(213, 198, 76)",this.fill_color=this.base_fill_color,this.character="wall",this.eps=.001}start(){0===this.i&&0===this.j&&(this.base_fill_color="green")}is_collision(t){if(0!==this.i||0!==this.j)return;let e=this.x+this.cube_side_len/2,s=this.y+this.cube_side_len/2,i=this.get_dist(e,s,t.x,t.y),a=Math.atan2(this.y-t.y,this.x-t.x),h=t.speed_angle,l=Math.abs(this.cube_side_len/2/Math.cos(a));return i-t.radius-l<this.eps&&(Math.abs(a-h)<Math.PI/2||Math.abs(a-h)>1.5*Math.PI)?(this.set_collision_color("rgb(213, 198, 76, 0.5)"),this.get_new_angle(a,h)):(this.set_collision_color(this.base_fill_color),!1)}get_new_angle(t,e){let s=0,i=0;if(Math.abs(t-e)<Math.PI/2){s=Math.PI/2-Math.abs(t-e);let a=e-t;i=t>0&&e>0&&a>0||t<0&&e>0&&a>0||t<0&&e<0&&a>0?e+s:e-s}else s=Math.PI/2-(2*Math.PI-Math.abs(t-e)),e<0&&t>0?i=e+s:e>0&&t<0&&(i=e-s);return i}set_player_point_color(){}set_collision_color(t){this.fill_color=t}render(t,e,s){this.ctx.save(),this.ctx.beginPath(),this.ctx.lineWidth=0,this.ctx.rect(t*s,e*s,this.cube_side_len*s,this.cube_side_len*s),this.ctx.fillStyle=this.fill_color,this.ctx.fill(),this.ctx.restore()}}class g extends u{constructor(t,e,s,i,a,h,l){super(t,e,s,i,a,h,l),this.state="",this.base_fill_color="rgb(136, 188, 194)",this.fill_color=this.base_fill_color,this.character="floor"}start(){}set_color(){}render(t,e,s){this.ctx.save(),this.ctx.beginPath(),this.ctx.lineWidth=0,this.ctx.rect(t*s,e*s,this.cube_side_len*s,this.cube_side_len*s),this.ctx.fillStyle=this.fill_color,this.ctx.fill(),this.ctx.restore()}}class y extends _{constructor(t,e){super(),this.playground=t,this.ctx=this.playground.ctx,this.canvas=e,this.width=this.playground.virtual_map_width,this.height=this.playground.virtual_map_height,this.cube_side_len=.05*this.height,this.nx=Math.ceil(this.width/this.cube_side_len),this.ny=Math.ceil(this.height/this.cube_side_len),this.grids=[],this.wall_img=new Image,this.wall_img.src="https://s3.bmp.ovh/imgs/2021/11/837412e46f4f61a6.jpg",this.background_color="gray",this.stroke_color="rgb(222, 237, 225)"}start(){this.load_map(),this.generate_grid()}get_random_color(){let t=["#00FFFF","#00FF7F","#8A2BE2","#CD2990","#7FFF00","#FFDAB9","#FF6437","#CD853F"];return t[Math.floor(6*Math.random())]}generate_grid(){for(let t=0;t<this.nx;t++)for(let e=0;e<this.ny;e++)1===this.map[t][e]?this.grids.push(new g(this,this.playground,this.ctx,t,e,this.cube_side_len,this.stroke_color)):0===this.map[t][e]&&this.grids.push(new p(this,this.playground,this.ctx,t,e,this.cube_side_len,this.stroke_color))}win(){}lose(){}restart(){}on_destroy(){while(this.grids&&this.grids.length>0)this.grids[0].destroy();this.grids=[],console.log("game map destroy DONE")}update(){this.render()}render(){this.ctx.fillStyle=this.background_color,this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}load_map(){this.map=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,1,1,0,0,1,1,1,0,0,0,0,1,1,1,0,0,1,1,0],[0,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,1,1,1,1,1,0,0,0,1,1,0,0,0,1,1,1,1,1,0],[0,1,1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,1,0],[0,1,1,0,1,1,0,1,1,1,1,1,1,0,1,1,0,1,1,0],[0,1,1,0,1,1,0,1,1,1,1,1,1,0,1,1,0,1,1,0],[0,1,1,0,1,1,0,1,1,1,1,1,1,0,1,1,0,1,1,0],[0,1,1,0,1,1,0,1,1,1,1,1,1,0,1,1,0,1,1,0],[0,1,1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,1,0],[0,1,1,1,1,1,0,0,0,1,1,0,0,0,1,1,1,1,1,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,0],[0,1,1,0,0,1,1,1,0,0,0,0,1,1,1,0,0,1,1,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]}}class m extends _{constructor(t,e,s,i,a,h,l,r,o){super(),this.playground=t,this.ctx=this.playground.ctx,this.x=e,this.y=s,this.radius=i,this.vx=a,this.vy=h,this.color=l,this.speed=r,this.move_length=o,this.friction=.9,this.eps=.001}start(){}update(){if(this.move_length<this.eps||this.speed<this.eps)return this.destroy(),!1;let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*t,this.y+=this.vy*t,this.move_length-=t,this.speed*=this.friction,this.render()}render(){let t=this.playground.scale,e=this.playground.my_calculate_relative_position_x(this.x),s=this.playground.my_calculate_relative_position_y(this.y);this.ctx.beginPath(),this.ctx.arc(e*t,s*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()}}class f extends _{constructor(t,e,s,i,a,h,l,r,o,n,_){super(),this.playground=t,this.player=e,this.x=s,this.y=i,this.vx=h,this.vy=l,this.radius=a,this.color=r,this.speed=2*o,this.move_length=n,this.damage=_,this.eps=.001,this.ctx=this.playground.ctx,this.cons_flag=!0}start(){}update(){if(this.move_length<this.eps)return this.destroy(),!1;this.update_move(),"enemy"!==this.player.character&&this.update_attack(),this.render()}update_move(){let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*t,this.y+=this.vy*t,this.move_length-=t}update_attack(){for(let t=0;t<this.playground.players.length;t++){let e=this.playground.players[t];this.player!==e&&this.is_collision(e)&&this.attack(e)}}get_dist(t,e,s,i){let a=t-s,h=e-i;return Math.sqrt(a*a+h*h)}is_collision(t){let e=this.get_dist(this.x,this.y,t.x,t.y);return e<this.radius+t.radius}attack(t){let e=Math.atan2(t.y-this.y,t.x-this.x),s=t.is_attacked(e,this.damage);"multi mode"===this.playground.store.state.game_mode&&this.playground.mps.send_fireball_attack(t.uuid,t.x,t.y,e,this.damage,this.uuid),s&&(this.player.level_up(),console.log("LEVEL UP: ",this.player.level),this.playground.store.state.game_mode),this.destroy()}on_destroy(){for(let t=0;t<this.playground.fireballs.length;t++)if(this.playground.fireballs[t]===this){this.playground.fireballs.splice(t,1);break}}render(){let t=this.playground.scale,e=this.playground.my_calculate_relative_position_x(this.x),s=this.playground.my_calculate_relative_position_y(this.y);this.playground.is_element_out_of_screen(e,s)||(this.ctx.beginPath(),this.ctx.arc(e*t,s*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill())}}class x extends _{constructor(t,e){super(),this.playground=t,this.ctx=this.playground.ctx,this.player=e,this.half_line=1.2*this.player.radius,this.botton_on_player=1.35*this.player.radius,this.x=this.player.x,this.y=this.player.y,this.background_color="grey",this.color=null,this.eps=.01}start(){"robot"===this.player.character||"enemy"===this.player.character?this.color="red":"me"===this.player.character?this.color="lightgreen":this.color="yellow"}player_component_update(){this.x=this.player.x,this.y=this.player.y,"fighting"===this.playground.store.state.game_state&&this.render()}render(){let t=this.playground.scale,e=this.playground.my_calculate_relative_position_x(this.x),s=this.playground.my_calculate_relative_position_y(this.y);this.playground.is_element_out_of_screen(e,s)||(this.ctx.beginPath(),this.ctx.moveTo((e-1.13*this.half_line)*t,(s-this.botton_on_player)*t),this.ctx.lineTo((e+1.13*this.half_line)*t,(s-this.botton_on_player)*t),this.ctx.lineWidth=11,this.ctx.strokeStyle="black",this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo((e-1.1*this.half_line)*t,(s-this.botton_on_player)*t),this.ctx.lineTo((e+1.1*this.half_line)*t,(s-this.botton_on_player)*t),this.ctx.lineWidth=9,this.ctx.strokeStyle=this.background_color,this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo((e-this.half_line)*t,(s-this.botton_on_player)*t),this.ctx.lineTo((e+(2*this.half_line*this.player.health/100-this.half_line))*t,(s-this.botton_on_player)*t),this.ctx.lineWidth=5,this.ctx.strokeStyle=this.color,this.ctx.stroke(),this.ctx.strokeStyle="black",this.ctx.lineWidth=1)}}class v extends _{constructor(t,e,s,i,a){super(),this.playground=t,this.ctx=this.playground.ctx,this.player=e,this.icon_x=s,this.icon_y=i,this.icon_r=a,this.name="Skill",this.base_cold_time=0,this.cold_time=this.base_cold_time,this.img=new Image,this.eps=.001}use_skill(){}receive_use_skill(){}late_late_update(){this.update_code_time(),"me"===this.player.character&&this.render_icon(),this.render()}update_code_time(){this.cold_time-=this.timedelta/1e3,this.cold_time=Math.max(this.cold_time,0)}render(){}render_icon(){let t=this.playground.scale;this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(this.icon_x*t,this.icon_y*t,this.icon_r*t,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.img,(this.icon_x-this.icon_r)*t,(this.icon_y-this.icon_r)*t,2*this.icon_r*t,2*this.icon_r*t),this.ctx.restore(),this.cold_time>0&&(this.ctx.beginPath(),this.ctx.moveTo(this.icon_x*t,this.icon_y*t),this.ctx.arc(this.icon_x*t,this.icon_y*t,this.icon_r*t,0-Math.PI/2,2*Math.PI*(1-this.cold_time/this.base_cold_time)-Math.PI/2,!0),this.ctx.lineTo(this.icon_x*t,this.icon_y*t),this.ctx.fillStyle="rgba(0, 0, 255, 0.5)",this.ctx.fill())}}class b extends v{constructor(t,e,s,i,a){super(t,e,s,i,a),this.name="FireBall",this.base_cold_time=1,this.cold_time=this.base_cold_time,this.img.src="https://cdn.acwing.com/media/article/image/2021/12/02/1_9340c86053-fireball.png"}use_skill(t,e){if(this.cold_time<this.eps){let s=this.shoot_fireball(t,e);if(this.cold_time=this.base_cold_time,"me"===this.player.character&&"multi mode"===this.playground.store.state.game_mode){let i={ball_uuid:s.uuid,tx:t,ty:e};this.playground.mps.send_use_general_skill(i)}}}receive_use_skill(t){let e=this.shoot_fireball(t["tx"],t["ty"]);e.uuid=t["ball_uuid"]}shoot_fireball(t,e){let s=.01*this.playground.height/this.playground.scale,i=Math.atan2(e-this.player.y,t-this.player.x),a=Math.cos(i),h=Math.sin(i),l="red",r=.5*this.playground.height/this.playground.scale,o=1.5*this.playground.height/this.playground.scale,n=null;return n="me"===this.player.character?new f(this.playground,this.player,this.player.x,this.player.y,s,a,h,l,r,o,50):new f(this.playground,this.player,this.player.x,this.player.y,s,a,h,l,r,o,10),this.playground.fireballs.push(n),n}}class k extends v{constructor(t,e,s,i,a){super(t,e,s,i,a),this.name="Blink",this.base_cold_time=3,this.cold_time=this.base_cold_time,this.img.src="https://cdn.acwing.com/media/article/image/2021/12/02/1_daccabdc53-blink.png"}use_skill(t,e){if(this.cold_time<this.eps&&(this.blink(t,e),this.cold_time=this.base_cold_time,"multi mode"===this.playground.store.state.game_mode)){let s={tx:t,ty:e};this.playground.mps.send_use_summoner_skill(s)}}receive_use_skill(t){this.blink(t["tx"],t["ty"])}blink(t,e){let s=this.get_dist(this.player.x,this.player.y,t,e);s=Math.min(s,.6);let i=Math.atan2(e-this.player.y,t-this.player.x);this.player.x+=s*Math.cos(i),this.player.y+=s*Math.sin(i)}get_dist(t,e,s,i){let a=t-s,h=e-i;return Math.sqrt(a*a+h*h)}}class w extends v{constructor(t,e,s,i,a){super(t,e,s,i,a),this.name="Shield",this.base_cold_time=2,this.cold_time=this.base_cold_time,this.shield_radius=2*this.player.radius,this.img.src="https://tank-war-static.oss-cn-hangzhou.aliyuncs.com/BattleOfBalls/skill/shield.jfif",this.color="rgb(158,55,155)",this.base_duration_time=3,this.duration_time=0}use_skill(){if(this.cold_time<this.eps&&(this.generate_shield(),this.cold_time=this.base_cold_time,"multi mode"===this.playground.store.state.game_mode)){let t={};this.playground.mps.send_use_awakened_skill(t)}}receive_use_skill(t){this.generate_shield()}generate_shield(){this.duration_time=this.base_duration_time}render(){if(this.duration_time<=this.eps)return this.duration_time=0,!1;let t=this.playground.scale,e=this.playground.my_calculate_relative_position_x(this.player.x),s=this.playground.my_calculate_relative_position_y(this.player.y);this.ctx.beginPath(),this.ctx.arc(e*t,s*t,this.shield_radius*t,0,2*Math.PI,!1),this.ctx.lineWidth=2,this.ctx.strokeStyle=this.color,this.ctx.stroke()}update(){this.update_duration_time(),this.update_destroy_ball()}update_duration_time(){this.duration_time-=this.timedelta/1e3,this.duration_time=Math.max(0,this.duration_time)}update_destroy_ball(){if(!(this.duration_time<this.eps))for(let t of this.playground.fireballs)t.player!==this.player&&this.is_collision(t)&&t.destroy()}is_collision(t){return this.get_dist(this.player.x,this.player.y,t.x,t.y)<=this.shield_radius+t.radius}get_dist(t,e,s,i){let a=t-s,h=e-i;return Math.sqrt(a*a+h*h)}}var M=s(8722);class S extends _{constructor(t,e,s){super(),this.playground=t,this.ctx=this.playground.ctx,this.player=e,this.max_length=s,this.angle=0,this.x=this.player.x,this.y=this.player.y,this.eps=.01}start(){"robot"===this.player.character||"enemy"===this.player.character?this.color="red":"me"===this.player.character?this.color="lightgreen":this.color="yellow"}late_update(){let t=this.playground.scale,e=this.playground.my_calculate_relative_position_x(this.player.x),s=this.playground.my_calculate_relative_position_y(this.player.y),i=this.playground.my_calculate_relative_position_x(this.player.tx),a=this.playground.my_calculate_relative_position_y(this.player.ty);"fighting"===this.playground.store.state.game_state&&this.render(t,e,s,i,a)}render(t,e,s,i,a){this.playground.is_element_out_of_screen(e,s)||(this.angle=Math.atan2(a*t-s*t,i*t-e*t),this.drawArrow(this.ctx,e*t,s*t,i*t,a*t,30,this.player.radius*t,.2*this.player.radius*t,"yellow"),this.ctx.strokeStyle="black",this.ctx.lineWidth=1)}drawArrow(t,e,s,i,a,h,l,r,o){h="undefined"!=typeof h?h:30,l="undefined"!=typeof h?l:10,r="undefined"!=typeof r?r:1,o="color"!=typeof o?o:"#000";var n=180*Math.atan2(s-a,e-i)/Math.PI,_=(n+h)*Math.PI/180,c=(n-h)*Math.PI/180,d=l*Math.cos(_),u=l*Math.sin(_),p=l*Math.cos(c),g=l*Math.sin(c);t.save(),t.beginPath();var y=e-d,m=s-u;t.moveTo(y,m),t.moveTo(e,s),t.lineTo(i,a),y=i+d,m=a+u,t.moveTo(y,m),t.lineTo(i,a),y=i+p,m=a+g,t.lineTo(y,m),t.strokeStyle=o,t.lineWidth=r,t.stroke(),t.restore()}}class P extends _{constructor(t,e,s,i,a,h,l,r,o){super(),this.playground=t,this.ctx=this.playground.ctx,this.x=e,this.y=s,this.vx=0,this.vy=0,this.base_radis=i,this.radius=this.base_radis,this.color=a,this.base_speed=h,this.speed=0,this.speed_angle=0,this.character=l,this.username=r,this.photo=o,this.decelerate_ratio=0,this.hero_name="Player",this.base_health=100,this.health=this.base_health,this.level=1,this.state="normal",this.eps=.001,this.directions=new Set,this.last_directions_size=0,this.skill_directions=new Set,this.last_skill_directions_size=0,this.cur_skill=null,this.rand_directions=new Set,this.tx=0,this.ty=0,this.friction=.9,this.spent_time=0,this.last_clientX=0,this.last_clientY=0,this.last_rect_left=0,this.last_rect_top=0,this.general_skill=new b(this.playground,this,.6,.9,.04),this.awakened_skill=new w(this.playground,this,.8,.9,.04),this.summoner_skill=new k(this.playground,this,1,.9,.04),this.health_bar=new x(this.playground,this),"me"===this.character&&(this.arrow=new S(this.playground,this,1))}start(){"multi mode"===this.playground.store.state.game_mode&&(this.playground.notice_board.add(),this.playground.notice_board.player_count>=3&&(this.playground.store.commit("updateGameState","fighting"),this.playground.notice_board.write("Fighting"))),this.ctx.canvas.focus(),"robot"!==this.character&&this.load_image(),"me"===this.character?(this.add_listening_events(),console.log("Hero Name:",this.hero_name)):"robot"===this.character&&(this.move_length=0,this.speed=this.get_speed(),this.robot_update())}level_up(){this.level+=1,this.health=this.base_health}change_state(t){"transformation"===t["skill_name"]?this.transformation(t["transformation_radis_ratio"]):"transformation_restore"===t["skill_name"]?this.transformation_restore():"ice_arrow"===t["skill_name"]&&(this.decelerate(t["decelerate_ratio"],t["time"]),console.log("DECELERATE:",this.decelerate_ratio))}get_speed(){return this.base_speed*(1-this.decelerate_ratio)}change_decelerate_ratio(t,e){e&&"add"===e?this.decelerate_ratio+=t:this.decelerate_ratio=t,this.speed>this.eps&&(this.speed=this.get_speed())}decelerate(t,e){let s=this;this.decelerate_id&&clearTimeout(this.decelerate_id),this.decelerate_ratio<1&&this.change_decelerate_ratio(t,"add"),this.decelerate_ratio>1&&(this.decelerate_ratio=1),console.log("time:",1e3*e),this.decelerate_id=setTimeout((function(){s.change_decelerate_ratio(0),s.decelerate_id=null,console.log("restore speed")}),1e3*e)}transformation(t){this.state="transformation",this.radius=this.base_radis*t}transformation_restore(){this.state="normal",this.radius=this.base_radis,this.change_decelerate_ratio(0)}load_image(){this.img=new Image;for(let t of M)if(t.name===this.hero_name){this.img.src=t.avatar;break}this.img.src||(this.img.src=this.photo)}add_listening_events(){this.ctx.canvas.addEventListener("contextmenu",(t=>{t.preventDefault()})),this.ctx.canvas.addEventListener("keydown",(t=>{if("Enter"===t.key?("multi mode"===this.playground.store.state.game_mode&&this.playground.chat_field.show_input(),t.preventDefault()):"Escape"===t.key&&("multi mode"===this.playground.store.state.game_mode&&this.playground.chat_field.hide_input(),t.preventDefault()),"fighting"!==this.playground.store.state.game_state)return!0;"w"===t.key||"W"===t.key||"ArrowUp"===t.key?(this.directions.add(0),t.preventDefault()):"d"===t.key||"D"===t.key||"ArrowRight"===t.key?(this.directions.add(1),t.preventDefault()):"s"===t.key||"S"===t.key||"ArrowDown"===t.key?(this.directions.add(2),t.preventDefault()):"a"===t.key||"A"===t.key||"ArrowLeft"===t.key?(this.directions.add(3),t.preventDefault()):"f"===t.key||"F"===t.key?this.cur_skill="summoner_skill"===this.cur_skill?null:"summoner_skill":" "===t.key&&this.awakened_skill.use_skill(this.tx,this.ty),this.update_move_toward()})),this.ctx.canvas.addEventListener("keyup",(t=>{"w"===t.key||"W"===t.key||"ArrowUp"===t.key?(this.directions.delete(0),t.preventDefault()):"d"===t.key||"D"===t.key||"ArrowRight"===t.key?(this.directions.delete(1),t.preventDefault()):"s"===t.key||"S"===t.key||"ArrowDown"===t.key?(this.directions.delete(2),t.preventDefault()):"a"!==t.key&&"A"!==t.key&&"ArrowLeft"!==t.key||(this.directions.delete(3),t.preventDefault()),this.update_move_toward()})),this.ctx.canvas.addEventListener("mousedown",(t=>{if("fighting"!==this.playground.store.state.game_state)return!1;this.save_clientX_clientY_rectLeft_rectRight(t),1===t.which&&(this.my_calculate_tx_ty(),null===this.cur_skill?(this.use_general_skill(),this.skill_directions.add("general_skill")):"summoner_skill"===this.cur_skill&&(this.use_summoner_skill(),this.cur_skill=null)),t.preventDefault()})),this.ctx.canvas.addEventListener("mouseup",(t=>{this.save_clientX_clientY_rectLeft_rectRight(t),this.skill_directions.delete("general_skill"),t.preventDefault()})),this.ctx.canvas.addEventListener("mousemove",(t=>{this.save_clientX_clientY_rectLeft_rectRight(t)}))}use_general_skill(){"transformation"!==this.state&&"silent"!==this.state&&"vertigo"!==this.state&&this.general_skill.use_skill(this.tx,this.ty)}use_summoner_skill(){"transformation"!==this.state&&"silent"!==this.state&&"vertigo"!==this.state&&this.summoner_skill.use_skill(this.tx,this.ty)}destroy_fireball(t){for(let e=0;e<this.playground.fireballs.length;e++){let s=this.playground.fireballs[e];if(s.uuid===t){s.destroy();break}}}scan_skills(t){t.has("general_skill")&&this.use_general_skill()}save_clientX_clientY_rectLeft_rectRight(t){this.last_clientX=t.clientX,this.last_clientY=t.clientY}my_calculate_tx_ty(){const t=this.ctx.canvas.getBoundingClientRect();this.last_rect_left=t.left,this.last_rect_top=t.top,this.tx=this.playground.my_calculate_tx(this.last_clientX-this.last_rect_left),this.ty=this.playground.my_calculate_ty(this.last_clientY-this.last_rect_top)}get_dist(t,e,s,i){let a=t-s,h=e-i;return Math.sqrt(a*a+h*h)}update_speed_angle(t){this.speed=this.get_speed(),1===t.size||3===t.size?t.has(0)&&!t.has(2)?this.speed_angle=-Math.PI/2:t.has(1)&&!t.has(3)?this.speed_angle=0:t.has(2)&&!t.has(0)?this.speed_angle=Math.PI/2:t.has(3)&&!t.has(1)&&(this.speed_angle=Math.PI):2===t.size?t.has(0)&&t.has(1)?this.speed_angle=-Math.PI/4:t.has(1)&&t.has(2)?this.speed_angle=Math.PI/4:t.has(2)&&t.has(3)?this.speed_angle=3*Math.PI/4:t.has(3)&&t.has(0)&&(this.speed_angle=3*-Math.PI/4):this.speed=0}is_attacked(t,e){for(let s=0;s<15+10*Math.random();s++){let t=this.radius*Math.random()*.1,e=2*Math.PI*Math.random(),s=Math.cos(e),i=Math.sin(e),a=this.color,h=4*this.speed,l=this.radius*Math.random()*5;new m(this.playground,this.x,this.y,t,s,i,a,h,l)}return this.health-=e,this.health<=0&&(this.player_lose(),!0)}receive_attack(t,e,s,i,a){this.x=t,this.y=e,this.is_attacked(s,i)}receive_fireball_attack(t,e,s,i,a,h){h.destroy_fireball(a),this.x=t,this.y=e,this.is_attacked(s,i)}player_lose(){"me"===this.character?"fighting"===this.playground.store.state.game_state&&(console.log("me LOST"),this.playground.score_board.lose()):"robot"===this.character&&this.playground.append_player(),this.destroy()}on_destroy(){this.health_bar&&this.health_bar.destroy(),this.health_bar=null,this.general_skill&&this.general_skill.destroy(),this.general_skill=null,this.awakened_skill&&this.awakened_skill.destroy(),this.awakened_skill=null,this.summoner_skill&&this.summoner_skill.destroy(),this.summoner_skill=null;for(let t=0;t<this.playground.players.length;t++)if(this.playground.players[t]===this){this.playground.players.splice(t,1);break}}robot_update(){if("silent"!==this.state&&"transformation"!==this.state&&this.auto_use_general_skill(),"displacement"!==this.state&&"vertigo"!==this.state)if(this.move_length<this.eps){this.move_length=0,this.vx=this.vy=0;let t=Math.random()*this.playground.virtual_map_width,e=Math.random()*this.playground.virtual_map_height;this.move_to(t,e)}else{let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*t,this.y+=this.vy*t,this.move_length-=t}}auto_use_general_skill(){let t=this.playground.players;if(this.spent_time>3&&Math.random()<1/180&&t.length>=2){let e=this;for(let s=0;e===this&&s<1e3;s++)e=t[Math.floor(Math.random()*t.length)];this.general_skill.use_skill(e.x,e.y)}}move_to(t,e){this.move_length=this.get_dist(this.x,this.y,t,e),this.speed_angle=Math.atan2(e-this.y,t-this.x),this.vx=Math.cos(this.speed_angle),this.vy=Math.sin(this.speed_angle)}update_move(){if("displacement"===this.state||"vertigo"===this.state)return!1;this.vx=this.speed*Math.cos(this.speed_angle),this.vy=this.speed*Math.sin(this.speed_angle),this.x+=this.vx*this.timedelta/1e3,this.y+=this.vy*this.timedelta/1e3}check_collision(){let t=this.playground.game_map.grids;for(let e=0;e<t.length;e++)if("wall"===t[e].character){t[e].is_collision(this)}}update_move_toward(){this.last_directions_size!==this.directions.size&&(this.update_speed_angle(this.directions),"multi mode"===this.playground.store.state.game_mode&&this.playground.mps.send_move_toward(this.directions,this.x,this.y),this.last_directions_size=this.directions.size)}update(){}late_update(){this.spent_time+=this.timedelta/1e3,"robot"===this.character&&("fighting"===this.playground.store.state.game_state&&this.robot_update(),this.render())}late_late_update(){"robot"!==this.character&&(this.my_calculate_tx_ty(),"fighting"===this.playground.store.state.game_state&&("me"===this.character&&this.update_win(),this.update_move(),this.update_attack()),this.render())}update_win(){1===this.playground.players.length&&this.playground.score_board.win()}update_attack(){this.scan_skills(this.skill_directions)}render(){let t=this.playground.scale,e=this.playground.my_calculate_relative_position_x(this.x),s=this.playground.my_calculate_relative_position_y(this.y);this.playground.is_element_out_of_screen(e,s)&&"me"!=this.character||("robot"!==this.character?(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(e*t,s*t,this.radius*t,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.img,(e-this.radius)*t,(s-this.radius)*t,2*this.radius*t,2*this.radius*t),this.ctx.restore()):(this.ctx.beginPath(),this.ctx.arc(e*t,s*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()))}}class I extends v{constructor(t,e,s,i,a){super(t,e,s,i,a),this.owner="太二",this.name="RapidFireSkill",this.skill_type="general_skill",this.base_cold_time=1,this.cold_time=0,this.base_fire_interval=.3,this.fire_interval=this.base_fire_interval,this.base_bullet=7,this.bullet=this.base_bullet,this.scatter=2,this.img.src="https://project-static-file.oss-cn-hangzhou.aliyuncs.com/AwakenedAlliance/aoyi/taier/general_skill.png"}start(){this.fresh_cold_time()}fresh_cold_time(){this.cold_time=0,this.fire_interval=0,this.bullet=this.base_bullet}use_skill(t,e){if(this.cold_time<this.eps&&this.fire_interval<this.eps&&this.bullet>0){let s=this.rapid_fire(t,e),i=[];for(let t of s)i.push(t.uuid);if(this.fire_interval=this.base_fire_interval,this.bullet-=1,this.bullet<=0&&(this.cold_time=this.base_cold_time),"me"===this.player.character&&"multi mode"===this.playground.store.state.game_mode){let s={ball_uuid_list:i,tx:t,ty:e};this.playground.mps.send_use_general_skill(s)}}}update_code_time(){this.cold_time-=this.timedelta/1e3,this.cold_time=Math.max(this.cold_time,0),this.fire_interval-=this.timedelta/1e3,this.fire_interval=Math.max(this.fire_interval,0),0===this.bullet&&this.cold_time<this.eps&&(this.bullet=this.base_bullet)}rapid_fire(t,e){let s=Math.PI/10,i=[];return 2===this.scatter?(i.push(this.shoot_fireball(t,e,s/2)),i.push(this.shoot_fireball(t,e,-s/2))):3===this.scatter?(i.push(this.shoot_fireball(t,e,s)),i.push(this.shoot_fireball(t,e,0)),i.push(this.shoot_fireball(t,e,-s))):4===this.scatter?(i.push(this.shoot_fireball(t,e,s/2)),i.push(this.shoot_fireball(t,e,1.5*s)),i.push(this.shoot_fireball(t,e,-s/2)),i.push(this.shoot_fireball(t,e,1.5*-s))):console.log("[SCATTER ERROR]"),i}receive_use_skill(t){let e=this.rapid_fire(t["tx"],t["ty"]),s=t["ball_uuid_list"];for(let i=0;i<e.length;i++)e[i].uuid=s[i].uuid}shoot_fireball(t,e,s){let i=.01*this.playground.height/this.playground.scale,a=Math.atan2(e-this.player.y,t-this.player.x);a+=s;let h=Math.cos(a),l=Math.sin(a),r="red",o=.8*this.playground.height/this.playground.scale,n=.4*this.playground.height/this.playground.scale,_=null;return _="me"===this.player.character?new f(this.playground,this.player,this.player.x,this.player.y,i,h,l,r,o,n,50):new f(this.playground,this.player,this.player.x,this.player.y,i,h,l,r,o,n,10),this.playground.fireballs.push(_),_}}class A extends v{constructor(t,e,s,i,a){super(t,e,s,i,a),this.owner="太二",this.name="Rolling",this.skill_type="awakened_skill",this.base_cold_time=1.8,this.cold_time=this.base_cold_time,this.img.src="https://project-static-file.oss-cn-hangzhou.aliyuncs.com/AwakenedAlliance/aoyi/taier/awakened_skill.png",this.speed=3*this.player.base_speed}use_skill(){if(this.cold_time<this.eps&&(this.rolling(),this.cold_time=this.base_cold_time,"multi mode"===this.playground.store.state.game_mode)){let t={};this.playground.mps.send_use_awakened_skill(t)}}receive_use_skill(t){this.rolling()}update_move(){if(this.move_length<this.eps)this.move_length=0,this.vx=this.vy=0,this.player.state="normal";else{let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.player.x+=this.vx*t,this.player.y+=this.vy*t,this.move_length-=t}}rolling(){this.player.state="displacement",this.player.general_skill.fresh_cold_time(),this.move_length=.3,this.speed_angle=this.player.speed_angle,this.vx=Math.cos(this.speed_angle),this.vy=Math.sin(this.speed_angle)}late_late_update(){this.update_code_time(),"me"===this.player.character&&this.render_icon(),this.render(),"displacement"===this.player.state&&this.update_move()}get_dist(t,e,s,i){let a=t-s,h=e-i;return Math.sqrt(a*a+h*h)}}class D extends P{constructor(t,e,s,i,a,h,l,r,o){super(t,e,s,i,a,h,l,r,o),this.hero_name="太二",this.general_skill=new I(this.playground,this,.6,.9,.04),this.awakened_skill=new A(this.playground,this,.8,.9,.04),this.summoner_skill=new k(this.playground,this,1,.9,.04)}level_up(){this.level+=1,5==this.level&&(this.general_skill.scatter=3),10==this.level&&(this.general_skill.scatter=4),this.health=this.base_health}}class T extends v{constructor(t,e,s,i,a){super(t,e,s,i,a),this.owner="小耶",this.name="MagicLightBall",this.skill_type="general_skill",this.base_cold_time=.8,this.cold_time=0,this.base_fire_interval=0,this.fire_interval=this.base_fire_interval,this.base_bullet=1,this.bullet=this.base_bullet,this.img.src="https://project-static-file.oss-cn-hangzhou.aliyuncs.com/AwakenedAlliance/aoyi/xiaoye/general_skill.png",this.radius=.02*this.playground.height/this.playground.scale,this.color="pink",this.speed=.8*this.playground.height/this.playground.scale,this.move_length=.6*this.playground.height/this.playground.scale,this.damage=80}start(){this.fresh_cold_time()}fresh_cold_time(){this.cold_time=0,this.fire_interval=0,this.bullet=this.base_bullet}use_skill(t,e){if(this.cold_time<this.eps&&this.fire_interval<this.eps&&this.bullet>0){let s=this.fire(t,e);if(this.fire_interval=this.base_fire_interval,this.bullet-=1,this.bullet<=0&&(this.cold_time=this.base_cold_time),"me"===this.player.character&&"multi mode"===this.playground.store.state.game_mode){let i={ball_uuid:s.uuid,tx:t,ty:e};this.playground.mps.send_use_general_skill(i)}}}fire(t,e){let s=this.shoot_fireball(t,e,0);return s}receive_use_skill(t){let e=this.fire(t["tx"],t["ty"]);e.uuid=t["ball_uuid"]}update_code_time(){this.cold_time-=this.timedelta/1e3,this.cold_time=Math.max(this.cold_time,0),this.fire_interval-=this.timedelta/1e3,this.fire_interval=Math.max(this.fire_interval,0),0===this.bullet&&this.cold_time<this.eps&&(this.bullet=this.base_bullet)}shoot_fireball(t,e,s){let i=Math.atan2(e-this.player.y,t-this.player.x);i+=s;let a=Math.cos(i),h=Math.sin(i),l=null;return l="me"===this.player.character?new f(this.playground,this.player,this.player.x,this.player.y,this.radius,a,h,this.color,this.speed,this.move_length,this.damage):new f(this.playground,this.player,this.player.x,this.player.y,this.radius,a,h,this.color,this.speed,this.move_length,10),this.playground.fireballs.push(l),l}}class E extends _{constructor(t,e,s,i,a,h){super(),this.playground=t,this.player=e,this.x=s,this.y=i,this.radius=a,this.color=h,this.eps=.001,this.ctx=this.playground.ctx,this.decelerate_ratio=.6,this.transformation_radis_ratio=.6,this.base_circle_duration=1,this.circle_duration=this.base_circle_duration,this.base_magic_duration=1.5,this.magic_duration=this.base_magic_duration,this.transformation_players=new Set}start(){}update(){this.update_duration_time(),this.update_inner_player(),this.render()}update_inner_player(){if(this.circle_duration>=this.eps)for(let t of this.playground.players)t!==this.player&&this.get_dist(t.x,t.y,this.x,this.y)<this.radius&&t.decelerate_ratio<this.decelerate_ratio?t.change_decelerate_ratio(this.decelerate_ratio):t!==this.player&&this.get_dist(t.x,t.y,this.x,this.y)>=this.radius&&t.decelerate_ratio>0&&t.change_decelerate_ratio(0);else if(this.transformation_players.size>0)for(let t of this.transformation_players)t.decelerate_ratio<this.decelerate_ratio&&t.change_decelerate_ratio(this.decelerate_ratio)}transformation_inner_player(){for(let t of this.playground.players)t!==this.player&&this.get_dist(t.x,t.y,this.x,this.y)<this.radius&&(t.change_decelerate_ratio(0),t.change_state({skill_name:"transformation",transformation_radis_ratio:this.transformation_radis_ratio}),this.transformation_players.add(t))}restore_players(){for(let t of this.transformation_players)t.change_state({skill_name:"transformation_restore"})}get_dist(t,e,s,i){let a=t-s,h=e-i;return Math.sqrt(a*a+h*h)}update_duration_time(){this.circle_duration>=this.eps?(this.circle_duration-=this.timedelta/1e3,this.circle_duration<this.eps&&(this.circle_duration=0,this.magic_duration=this.base_magic_duration,this.transformation_inner_player())):this.magic_duration-=this.timedelta/1e3,this.magic_duration<this.eps&&this.destroy()}on_destroy(){this.restore_players(),this.transformation_players.clear()}render(){if(this.circle_duration<this.eps)return;let t=this.playground.scale,e=this.playground.my_calculate_relative_position_x(this.x),s=this.playground.my_calculate_relative_position_y(this.y);this.playground.is_element_out_of_screen(e,s)||(this.ctx.beginPath(),this.ctx.arc(e*t,s*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill())}}class R extends v{constructor(t,e,s,i,a){super(t,e,s,i,a),this.owner="小耶",this.name="MagicalMagic",this.skill_type="awakened_skill",this.base_cold_time=1.8,this.cold_time=this.base_cold_time,this.img.src="https://project-static-file.oss-cn-hangzhou.aliyuncs.com/AwakenedAlliance/aoyi/xiaoye/awakened_skill.png",this.radius=.11*this.playground.height/this.playground.scale,this.color="pink",this.base_bullet=1,this.bullet=this.base_bullet}use_skill(){if(this.cold_time<this.eps&&(this.magic(this.player.tx,this.player.ty),this.bullet-=1,this.bullet<=0&&(this.cold_time=this.base_cold_time),"multi mode"===this.playground.store.state.game_mode)){let t={tx:this.player.tx,ty:this.player.ty};this.playground.mps.send_use_awakened_skill(t)}}receive_use_skill(t){this.magic(t["tx"],t["ty"])}update_move(){if(this.move_length<this.eps)this.move_length=0,this.vx=this.vy=0,this.player.state="normal";else{let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.player.x+=this.vx*t,this.player.y+=-this.vy*t,this.move_length-=t}}magic(t,e){this.magic_circle=new E(this.playground,this.player,t,e,this.radius,this.color)}update_code_time(){this.cold_time-=this.timedelta/1e3,this.cold_time=Math.max(this.cold_time,0),0===this.bullet&&this.cold_time<this.eps&&(this.bullet=this.base_bullet)}late_late_update(){this.update_code_time(),"me"===this.player.character&&this.render_icon(),this.render(),"displacement"===this.player.state&&this.update_move()}get_dist(t,e,s,i){let a=t-s,h=e-i;return Math.sqrt(a*a+h*h)}}class z extends P{constructor(t,e,s,i,a,h,l,r,o){super(t,e,s,i,a,h,l,r,o),this.hero_name="小耶",this.general_skill=new T(this.playground,this,.6,.9,.04),this.awakened_skill=new R(this.playground,this,.8,.9,.04),this.summoner_skill=new k(this.playground,this,1,.9,.04)}level_up(){this.level+=1,5===this.level&&(this.general_skill.damage*=1.5),10===this.level&&(this.awakened_skill.base_bullet=2),this.health=this.base_health}}class F extends v{constructor(t,e,s,i,a){super(t,e,s,i,a),this.owner="龙炎",this.name="DivineAxeSkill",this.skill_type="general_skill",this.damage=70,this.player_base_speed=this.player.base_speed,this.base_cold_time=.6,this.cold_time=0,this.base_fire_interval=0,this.fire_interval=this.base_fire_interval,this.base_bullet=1,this.bullet=this.base_bullet,this.hit_numbers=0,this.axe_length=4*this.player.radius,this.axe_width=1.2*this.player.radius,this.base_duration=.3,this.duration=0,this.base_accelerate_time=1.5,this.accelerate_time=0,this.is_accelerating=!1,this.accelerate_ratio=2,this.angle=0,this.can_hit=!1,this.color="rgba(255, 0, 0, 0.6)",this.img.src="https://project-static-file.oss-cn-hangzhou.aliyuncs.com/AwakenedAlliance/aoyi/longyan/general_skill.png"}start(){this.fresh_cold_time()}fresh_cold_time(){this.cold_time=0,this.fire_interval=0,this.bullet=this.base_bullet}use_skill(t,e){if(this.cold_time<this.eps&&this.fire_interval<this.eps&&this.bullet>0){this.axe(t,e);if(this.fire_interval=this.base_fire_interval,this.bullet-=1,this.can_hit=!0,this.bullet<=0&&(this.cold_time=this.base_cold_time),"me"===this.player.character&&"multi mode"===this.playground.store.state.game_mode){let s={tx:t,ty:e};this.playground.mps.send_use_general_skill(s)}}}update_code_time(){this.cold_time-=this.timedelta/1e3,this.cold_time=Math.max(this.cold_time,0),this.fire_interval-=this.timedelta/1e3,this.fire_interval=Math.max(this.fire_interval,0),this.duration-=this.timedelta/1e3,this.duration=Math.max(this.duration,0),this.accelerate_time-=this.timedelta/1e3,this.accelerate_time=Math.max(this.accelerate_time,0),0===this.bullet&&this.cold_time<this.eps&&(this.bullet=this.base_bullet),this.is_accelerating&&this.accelerate_time<this.eps&&this.restore_accelerate(),this.update_hit_player()}restore_accelerate(){this.player.base_speed=this.player_base_speed,this.player.speed>this.eps&&(this.player.speed=this.player.get_speed()),this.is_accelerating=!1}accelerate(){this.player.base_speed=2*this.player_base_speed,this.player.speed>this.eps&&(this.player.speed=this.player.get_speed()),this.is_accelerating=!0,this.accelerate_time=this.base_accelerate_time}update_hit_player(){if(this.can_hit&&this.duration<this.eps){this.can_hit=!1;let t=this.hit_palyer();t&&(this.hit_numbers+=1,this.hit_numbers%3===0&&this.accelerate())}}hit_palyer(){let t=!1;for(let e of this.playground.players)e!==this.player&&this.is_collision(e)&&(t=!0,this.attack(e));return t}attack(t){let e=t.is_attacked(this.new_angle,this.damage);"multi mode"===this.playground.store.state.game_mode&&this.playground.mps.send_attack(t.uuid,t.x,t.y,this.angle,this.damage,this.uuid),e&&(this.player.level_up(),console.log("LEVEL UP: ",this.player.level),this.playground.store.state.game_mode)}is_collision(t){let e=this.playground.my_calculate_relative_position_x(this.player.x),s=this.playground.my_calculate_relative_position_y(this.player.y),i=this.playground.my_calculate_relative_position_x(t.x),a=this.playground.my_calculate_relative_position_y(t.y),h=e+this.axe_length/2*Math.cos(this.angle),l=s+this.axe_length/2*Math.sin(this.angle);this.new_angle=Math.atan2(a-l,i-h);let r=this.get_dist(i,a,h,l),o=Math.abs(r*Math.cos(this.new_angle-this.angle)),n=Math.abs(r*Math.sin(this.new_angle-this.angle));return o<=this.axe_length/2+t.radius&&n<=this.axe_width/2+t.radius}axe(t,e){this.angle=Math.atan2(e-this.player.y,t-this.player.x),this.duration=this.base_duration}get_dist(t,e,s,i){let a=t-s,h=e-i;return Math.sqrt(a*a+h*h)}receive_use_skill(t){this.axe(t["tx"],t["ty"])}render(){if(this.duration<this.eps)return;let t=this.playground.scale,e=this.playground.my_calculate_relative_position_x(this.player.x),s=this.playground.my_calculate_relative_position_y(this.player.y),i=e+this.axe_length*Math.cos(this.angle),a=s+this.axe_length*Math.sin(this.angle);this.playground.is_element_out_of_screen(e,s)||(this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(e*t,s*t),this.ctx.lineTo(i*t,a*t),this.ctx.strokeStyle=this.color,this.ctx.lineWidth=this.axe_width*t*(1-this.duration/this.base_duration),this.ctx.stroke(),this.ctx.restore())}}class C extends v{constructor(t,e,s,i,a){super(t,e,s,i,a),this.owner="龙炎",this.name="HeroCharge",this.skill_type="awakened_skill",this.base_cold_time=1.8,this.cold_time=this.base_cold_time,this.base_move_length=.6,this.img.src="https://project-static-file.oss-cn-hangzhou.aliyuncs.com/AwakenedAlliance/aoyi/longyan/awakened_skill.png",this.speed=4.5*this.player.base_speed,this.base_bullet=1,this.bullet=this.base_bullet,this.inner_players=new Set}start(){}use_skill(){let t=this.player.arrow.angle;if(this.cold_time<this.eps&&(this.charge(t),this.bullet-=1,this.bullet<=0&&(this.cold_time=this.base_cold_time),"multi mode"===this.playground.store.state.game_mode)){let e={player_arrow_angle:t};this.playground.mps.send_use_awakened_skill(e)}}receive_use_skill(t){this.charge(t["player_arrow_angle"])}update_move(){if(this.move_length<this.eps){this.move_length=0,this.vx=this.vy=0,this.player.state="normal";for(let t of this.inner_players)setTimeout((function(){t.state="normal"}),500)}else{let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.player.x+=this.vx*t,this.player.y+=this.vy*t,this.move_length-=t,this.update_inner_player_move(this.vx,this.vy,t)}}update_inner_player_move(t,e,s){for(let i of this.playground.players)i!==this.player&&this.get_dist(this.player.x,this.player.y,i.x,i.y)<=this.player.radius+i.radius&&(i.state="vertigo",this.inner_players.add(i),i.x+=t*s,i.y+=e*s)}charge(t){this.player.state="displacement",this.player.general_skill.fresh_cold_time(),this.move_length=this.base_move_length,this.speed_angle=t,this.vx=Math.cos(this.speed_angle),this.vy=Math.sin(this.speed_angle)}late_late_update(){this.update_code_time(),"me"===this.player.character&&this.render_icon(),this.render(),"displacement"===this.player.state&&this.update_move()}update_code_time(){this.cold_time-=this.timedelta/1e3,this.cold_time=Math.max(this.cold_time,0),0===this.bullet&&this.cold_time<this.eps&&(this.bullet=this.base_bullet)}get_dist(t,e,s,i){let a=t-s,h=e-i;return Math.sqrt(a*a+h*h)}}class O extends P{constructor(t,e,s,i,a,h,l,r,o){super(t,e,s,i,a,h,l,r,o),this.hero_name="龙炎",this.general_skill=new F(this.playground,this,.6,.9,.04),this.awakened_skill=new C(this.playground,this,.8,.9,.04),this.summoner_skill=new k(this.playground,this,1,.9,.04)}level_up(){this.level+=1,5==this.level&&(this.general_skill.damage*=1.5),10==this.level&&(this.awakened_skill.base_bullet=2),this.health=this.base_health}}class j extends f{constructor(t,e,s,i,a,h,l,r,o,n,_,c,d){super(t,e,s,i,a,h,l,r,o,n,_),this.decelerate_ratio=c,this.decelerate_time=d,this.color="rgba(0, 0, 255, 0.8)"}attack(t){let e=Math.atan2(t.y-this.y,t.x-this.x),s=t.is_attacked(e,this.damage);"multi mode"===this.playground.store.state.game_mode&&this.playground.mps.send_fireball_attack(t.uuid,t.x,t.y,e,this.damage,this.uuid),s?(this.player.level_up(),console.log("LEVEL UP: ",this.player.level),this.playground.store.state.game_mode):(t.change_state({skill_name:"ice_arrow",decelerate_ratio:this.decelerate_ratio,time:this.decelerate_time}),"multi mode"===this.playground.store.state.game_mode&&this.playground.mps.send_player_change_state(t.uuid,{skill_name:"ice_arrow",decelerate_ratio:this.decelerate_ratio,time:this.decelerate_time,arrow_uuid:this.uuid})),this.destroy()}}class L extends v{constructor(t,e,s,i,a){super(t,e,s,i,a),this.owner="帝释天",this.name="IceArrowSkill",this.skill_type="general_skill",this.base_cold_time=.5,this.cold_time=0,this.decelerate_ratio=.2,this.decelerate_time=.8,this.damage=20,this.radius=.02*this.playground.height/this.playground.scale,this.speed=.8*this.playground.height/this.playground.scale,this.move_length=.6*this.playground.height/this.playground.scale,this.base_fire_interval=0,this.fire_interval=this.base_fire_interval,this.base_bullet=1,this.bullet=this.base_bullet,this.img.src="https://project-static-file.oss-cn-hangzhou.aliyuncs.com/AwakenedAlliance/aoyi/dishitian/general_skill.png"}start(){this.fresh_cold_time()}fresh_cold_time(){this.cold_time=0,this.fire_interval=0,this.bullet=this.base_bullet}use_skill(t,e){if(this.cold_time<this.eps&&this.fire_interval<this.eps&&this.bullet>0){let s=this.archery(t,e);if(this.fire_interval=this.base_fire_interval,this.bullet-=1,this.bullet<=0&&(this.cold_time=this.base_cold_time),"me"===this.player.character&&"multi mode"===this.playground.store.state.game_mode){let i={ball_uuid:s.uuid,tx:t,ty:e};this.playground.mps.send_use_general_skill(i)}}}update_code_time(){this.cold_time-=this.timedelta/1e3,this.cold_time=Math.max(this.cold_time,0),this.fire_interval-=this.timedelta/1e3,this.fire_interval=Math.max(this.fire_interval,0),0===this.bullet&&this.cold_time<this.eps&&(this.bullet=this.base_bullet)}archery(t,e){let s=this.shoot_fireball(t,e);return s}receive_use_skill(t){let e=this.archery(t["tx"],t["ty"]);e.uuid=t["ball_uuid"]}shoot_fireball(t,e){let s=Math.atan2(e-this.player.y,t-this.player.x),i=Math.cos(s),a=Math.sin(s),h="rgba(0, 0, 255, 0.8)",l=null;return l="me"===this.player.character?new j(this.playground,this.player,this.player.x,this.player.y,this.radius,i,a,h,this.speed,this.move_length,this.damage,this.decelerate_ratio,this.decelerate_time):new j(this.playground,this.player,this.player.x,this.player.y,this.radius,i,a,h,this.speed,this.move_length,10,this.decelerate_ratio,this.decelerate_time),this.playground.fireballs.push(l),l}}class W extends v{constructor(t,e,s,i,a){super(t,e,s,i,a),this.owner="帝释天",this.name="ThousandArrowsSkill",this.skill_type="awakened_skill",this.base_cold_time=2,this.cold_time=0,this.decelerate_ratio=this.player.general_skill.decelerate_ratio,this.decelerate_time=this.player.general_skill.decelerate_time,this.damage=this.player.general_skill.damage,this.radius=this.player.general_skill.radius,this.speed=this.player.general_skill.speed,this.move_length=this.player.general_skill.move_length,this.base_fire_interval=0,this.fire_interval=this.base_fire_interval,this.base_bullet=1,this.bullet=this.base_bullet,this.scatter=3,this.img.src="https://project-static-file.oss-cn-hangzhou.aliyuncs.com/AwakenedAlliance/aoyi/dishitian/awakened_skill.png"}start(){this.fresh_cold_time()}fresh_cold_time(){this.cold_time=0,this.fire_interval=0,this.bullet=this.base_bullet}use_skill(t,e){if(this.cold_time<this.eps&&this.fire_interval<this.eps&&this.bullet>0){let s=this.archery(t,e),i=[];for(let t of s)i.push(t.uuid);if(this.fire_interval=this.base_fire_interval,this.bullet-=1,this.bullet<=0&&(this.cold_time=this.base_cold_time),"me"===this.player.character&&"multi mode"===this.playground.store.state.game_mode){let s={ball_uuid_list:i,tx:t,ty:e};this.playground.mps.send_use_awakened_skill(s)}}}update_code_time(){this.cold_time-=this.timedelta/1e3,this.cold_time=Math.max(this.cold_time,0),this.fire_interval-=this.timedelta/1e3,this.fire_interval=Math.max(this.fire_interval,0),0===this.bullet&&this.cold_time<this.eps&&(this.bullet=this.base_bullet)}archery(t,e){let s=Math.PI/10,i=[];return 3===this.scatter?(i.push(this.shoot_fireball(t,e,s)),i.push(this.shoot_fireball(t,e,0)),i.push(this.shoot_fireball(t,e,-s))):5===this.scatter?(i.push(this.shoot_fireball(t,e,s)),i.push(this.shoot_fireball(t,e,-s)),i.push(this.shoot_fireball(t,e,0)),i.push(this.shoot_fireball(t,e,2*s)),i.push(this.shoot_fireball(t,e,2*-s))):console.log("[SCATTER ERROR]"),i}receive_use_skill(t){let e=this.archery(t["tx"],t["ty"]);for(let s=0;s<e.length;s++)e[s].uuid=t.ball_uuid_list[s]}shoot_fireball(t,e,s){let i=Math.atan2(e-this.player.y,t-this.player.x);i+=s;let a=Math.cos(i),h=Math.sin(i),l="red",r=null;return r="me"===this.player.character?new j(this.playground,this.player,this.player.x,this.player.y,this.radius,a,h,l,this.speed,this.move_length,this.damage,this.decelerate_ratio,this.decelerate_time):new j(this.playground,this.player,this.player.x,this.player.y,this.radius,a,h,l,this.speed,this.move_length,10,this.decelerate_ratio,this.decelerate_time),this.playground.fireballs.push(r),r}}class q extends P{constructor(t,e,s,i,a,h,l,r,o){super(t,e,s,i,a,h,l,r,o),this.hero_name="帝释天",this.general_skill=new L(this.playground,this,.6,.9,.04),this.awakened_skill=new W(this.playground,this,.8,.9,.04),this.summoner_skill=new k(this.playground,this,1,.9,.04)}level_up(){this.level+=1,5==this.level&&(this.awakened_skill.scatter=5),10==this.level&&(this.general_skill.decelerate_ratio,this.general_skill.decelerate_time),this.health=this.base_health}}class Z{constructor(t){this.playground=t,this.ws=new WebSocket("wss://app4689.acapp.acwing.com.cn:4436/wss/multiplayer/"),this.start()}start(){this.receive()}receive(){let t=this;this.ws.onmessage=function(e){let s=JSON.parse(e.data),i=s.uuid;if(i===t.uuid)return!1;let a=s.event;"create_player"===a?t.receive_create_player(i,s.username,s.photo):"move_toward"===a?t.receive_move_toward(i,s.directions_array,s.x,s.y):"use_general_skill"===a?t.receive_use_general_skill(i,s.skill_data):"use_awakened_skill"===a?t.receive_use_awakened_skill(i,s.skill_data):"use_summoner_skill"===a?t.receive_use_summoner_skill(i,s.skill_data):"fireball_attack"===a?t.receive_fireball_attack(i,s.attackee_uuid,s.x,s.y,s.angle,s.damage,s.ball_uuid):"attack"===a?t.receive_attack(i,s.attackee_uuid,s.x,s.y,s.angle,s.damage):"message"===a?t.receive_chat_message(i,s.username,s.text):"update_player_info"===a?t.receive_update_player_info(i,s.hero_name):"player_change_state"===a&&t.receive_player_change_state(i,s.attackee_uuid,s.data)}}get_player(t){let e=this.playground.players;for(let s=0;s<e.length;s++){let i=e[s];if(i.uuid===t)return i}return null}send_create_player(t,e,s){let i=this;this.ws.send(JSON.stringify({event:"create_player",uuid:i.uuid,username:t,photo:e,hero_name:s}))}receive_create_player(t,e,s){let i=null,a=.5*this.playground.width/this.playground.scale,h=.5*this.playground.height/this.playground.scale;i=new P(this.playground,a,h,.05*this.playground.height/this.playground.scale,"white",.3*this.playground.height/this.playground.scale,"enemy",e,s),i.uuid=t,this.playground.players.push(i),this.send_update_player_info()}send_move_toward(t,e,s){let i=this,a=[...t];this.ws.send(JSON.stringify({event:"move_toward",uuid:i.uuid,directions_array:a,x:e,y:s}))}receive_move_toward(t,e,s,i){let a=this.get_player(t);if(a){let t=new Set(e);a.x=s,a.y=i,a.update_speed_angle(t)}}send_update_player_info(){let t=this;this.ws.send(JSON.stringify({event:"update_player_info",uuid:t.uuid,hero_name:t.playground.store.state.select_hero_name}))}receive_update_player_info(t,e){let s=this.get_player(t),i=s.username,a=s.photo;s.destroy();let h=.5*this.playground.width/this.playground.scale,l=.5*this.playground.height/this.playground.scale;"太二"===e?s=new D(this.playground,h,l,.05*this.playground.height/this.playground.scale,"white",.3*this.playground.height/this.playground.scale,"enemy",i,a):"小耶"===e?s=new z(this.playground,h,l,.05*this.playground.height/this.playground.scale,"white",.3*this.playground.height/this.playground.scale,"enemy",i,a):"龙炎"===e?s=new O(this.playground,h,l,.05*this.playground.height/this.playground.scale,"white",.3*this.playground.height/this.playground.scale,"enemy",i,a):"帝释天"===e?s=new q(this.playground,h,l,.05*this.playground.height/this.playground.scale,"white",.3*this.playground.height/this.playground.scale,"enemy",i,a):console.log("ERROR not a hero"),s.uuid=t,this.playground.players.push(s)}send_use_general_skill(t){let e=this;this.ws.send(JSON.stringify({event:"general_skill",uuid:e.uuid,skill_data:t}))}receive_use_general_skill(t,e){let s=this.get_player(t);s&&s.general_skill.receive_use_skill(e)}send_use_awakened_skill(t){let e=this;this.ws.send(JSON.stringify({event:"awakened_skill",uuid:e.uuid,skill_data:t}))}receive_use_awakened_skill(t,e){let s=this.get_player(t);s&&s.awakened_skill.receive_use_skill(e)}send_use_summoner_skill(t){let e=this;this.ws.send(JSON.stringify({event:"summoner_skill",uuid:e.uuid,skill_data:t}))}receive_use_summoner_skill(t,e){let s=this.get_player(t);s&&s.summoner_skill.receive_use_skill(e)}send_attack(t,e,s,i,a){let h=this;this.ws.send(JSON.stringify({event:"attack",uuid:h.uuid,attackee_uuid:t,x:e,y:s,angle:i,damage:a}))}receive_attack(t,e,s,i,a,h){let l=this.get_player(t),r=this.get_player(e);l&&r&&r.receive_attack(s,i,a,h,l)}send_fireball_attack(t,e,s,i,a,h){let l=this;this.ws.send(JSON.stringify({event:"fireball_attack",uuid:l.uuid,attackee_uuid:t,x:e,y:s,angle:i,damage:a,ball_uuid:h}))}receive_fireball_attack(t,e,s,i,a,h,l){let r=this.get_player(t),o=this.get_player(e);r&&o&&o.receive_fireball_attack(s,i,a,h,l,r)}receive_blink(t,e,s){let i=this.get_player(t);i&&i.blink(e,s)}send_chat_message(t,e){let s=this;this.ws.send(JSON.stringify({event:"message",uuid:s.uuid,username:t,text:e}))}receive_chat_message(t,e,s){this.playground.chat_field.receive_add_message(e,s)}send_player_change_state(t,e){let s=this;this.ws.send(JSON.stringify({event:"player_change_state",uuid:s.uuid,attackee_uuid:t,data:e}))}receive_player_change_state(t,e,s){let i=this.get_player(t),a=this.get_player(e);i&&a&&a.change_state(s)}}class N extends _{constructor(t){super(),this.playground=t,this.ctx=this.playground.ctx,this.player_count=0,this.text="已就绪：0人"}start(){}add(){this.player_count+=1,this.write("已就绪："+this.player_count+"人")}write(t){this.text=t}late_late_update(){this.render()}render(){this.ctx.font="40px serif",this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.fillText(this.text,this.playground.width/2,.1*this.playground.height)}}var B=s(7387),U=s.n(B),J=s(680);class H{constructor(t,e){this.playground=t,this.store=this.playground.store,this.chat_field_ref=e,this.func_id=null,this.start()}start(){this.add_listening_events()}add_listening_events(){this.chat_field_ref.chat_field_input_ref.addEventListener("keydown",(t=>{if(console.log("in {chat}",t.key),"Enter"===t.key){console.log(this.store.state.username,this.chat_field_ref.chat_field_input_ref.value);let e=this.store.state.username,s=this.chat_field_ref.chat_field_input_ref.value;""!==s&&(this.chat_field_ref.chat_field_input_ref.value="",this.add_message(e,s),this.playground.mps.send_chat_message(e,s)),this.hide_input(),t.preventDefault()}else"Escape"===t.key&&(this.hide_input(),t.preventDefault())}))}render_message(t){return U()(`<div>${t}</div>`)}add_message(t,e){let s=`[${t}] ${e}`;this.chat_field_ref.chat_field_history_ref.append(this.render_message(s)[0]),this.chat_field_ref.chat_field_history_ref.scrollTop=this.chat_field_ref.chat_field_history_ref.scrollHeight}receive_add_message(t,e){this.add_message(t,e),this.show_history(),this.func_id&&clearTimeout(this.func_id);let s=this;this.func_id=setTimeout((function(){s.playground.store.commit("updateShowHistory",!1),s.func_id=null}),3e3),console.log(this.func_id)}show_history(){this.playground.store.commit("updateShowHistory",!0)}show_input(){this.func_id&&clearTimeout(this.func_id),this.show_history(),this.playground.store.commit("updateChatting",!0),this.chat_field_ref.chat_field_input_ref.focus()}hide_input(){this.playground.store.commit("updateChatting",!1),this.playground.ctx.canvas.focus();let t=this;this.func_id=setTimeout((function(){t.playground.store.commit("updateShowHistory",!1),t.func_id=null}),3e3),console.log(this.func_id)}}class X extends _{constructor(t){super(),this.playground=t,this.ctx=this.playground.ctx,this.store=this.playground.store,this.win_img=new Image,this.win_img.src="https://cdn.acwing.com/media/article/image/2021/12/17/1_8f58341a5e-win.png",this.lose_img=new Image,this.lose_img.src="https://cdn.acwing.com/media/article/image/2021/12/17/1_9254b5f95e-lose.png",this.start()}start(){}add_listening_events(){if(!this.ctx.canvas)return!1;this.ctx.canvas.addEventListener("mouseup",(t=>{console.log("typeof plg: ",typeof this.playground),this.playground.show_select_mode()}))}win(){this.playground.update_score(),this.store.commit("updateGameState","win");let t=this;setTimeout((function(){t.add_listening_events()}),500)}lose(){this.playground.update_score(),this.store.commit("updateGameState","lose");let t=this;setTimeout((function(){t.add_listening_events()}),500),console.log("score_board add_listenint_events DONE")}late_late_update(){this.render()}render(){let t=this.playground.height/2;"win"===this.store.state.game_state?this.ctx.drawImage(this.win_img,this.playground.width/2-t/2,this.playground.height/2-t/2,t,t):"lose"==this.store.state.game_state&&this.ctx.drawImage(this.lose_img,this.playground.width/2-t/2,this.playground.height/2-t/2,t,t)}}var Y=s(1120);class $ extends _{constructor(t,e,s,i,a){super(),this.canvas=t,this.ctx=e,this.div=s,this.store=i,this.width=this.div.clientWidth,this.height=this.div.clientHeight,this.chat_field_ref=a,this.scale=this.height,this.players=[],this.fireballs=[],this.virtual_map_width=3,this.virtual_map_height=this.virtual_map_width,this.ctx_x=.5*this.width/this.scale,this.ctx_y=.5*this.height/this.scale,this.game_map=new y(this,this.canvas)}start(){this.resize();let t=this,e=this.create_uuid();U()(window).on(`resize.${e}`,(function(){t.resize(),console.log("window.resize()")})),"AcWingOS"!==this.store.state.AcWingOS&&this.store.state.AcWingOS.api.window.on_close((function(){U()(window).off(`resize.${e}`),t.hide()}))}quit(){this.show_select_mode()}restart(t){let e=this;this.store.commit("updateScore",0),this.store.commit("updateGameState","waiting");let s=null;if(s="太二"===this.store.state.select_hero_name?new D(this,.5*this.width/this.scale,.5*this.height/this.scale,.05*this.height/this.scale,"white",.3*this.height/this.scale,"me",this.store.state.username,this.store.state.photo):"小耶"===this.store.state.select_hero_name?new z(this,.5*this.width/this.scale,.5*this.height/this.scale,.05*this.height/this.scale,"white",.3*this.height/this.scale,"me",this.store.state.username,this.store.state.photo):"龙炎"===this.store.state.select_hero_name?new O(this,.5*this.width/this.scale,.5*this.height/this.scale,.05*this.height/this.scale,"white",.3*this.height/this.scale,"me",this.store.state.username,this.store.state.photo):"帝释天"===this.store.state.select_hero_name?new q(this,.5*this.width/this.scale,.5*this.height/this.scale,.05*this.height/this.scale,"white",.3*this.height/this.scale,"me",this.store.state.username,this.store.state.photo):new D(this,.5*this.width/this.scale,.5*this.height/this.scale,.05*this.height/this.scale,"white",.3*this.height/this.scale,"me",this.store.state.username,this.store.state.photo),this.players.push(s),this.re_calculate_cx_cy(s.x,s.y),this.focus_player=s,this.ctx.canvas.focus(),"single mode"===t){for(let t=0;t<20;t++){let t=Math.random()*this.virtual_map_width,e=Math.random()*this.virtual_map_height;this.players.push(new P(this,t,e,.05*this.height/this.scale,this.get_random_color(),.3*this.height/this.scale,"robot"))}this.store.commit("updateGameState","fighting")}else"multi mode"===t&&(this.notice_board=new N(this),this.chat_field=new H(this,this.chat_field_ref),this.mps=new Z(this),this.mps.uuid=this.players[0].uuid,this.mps.ws.onopen=function(){e.mps.send_create_player(e.store.state.username,e.store.state.photo)});this.score_board=new X(this)}create_uuid(){let t="";for(let e=0;e<20;e++){let e=parseInt(Math.floor(10*Math.random()));t+=e}return t}resize(){this.ctx.canvas.width=this.div.clientWidth,this.ctx.canvas.height=this.div.clientHeight,this.width=this.div.clientWidth,this.height=this.div.clientHeight,this.scale=this.height}my_calculate_relative_position_x(t){return t-this.ctx_x+.5*this.width/this.scale}my_calculate_relative_position_y(t){return t-this.ctx_y+.5*this.height/this.scale}my_calculate_tx(t){return(t-.5*this.width)/this.scale+this.ctx_x}my_calculate_ty(t){return(t-.5*this.height)/this.scale+this.ctx_y}re_calculate_cx_cy(t,e){this.cx=t-.5*this.width/this.scale,this.cy=e-.5*this.height/this.scale;let s=this.game_map.cube_side_len;this.focus_player&&(this.cx=Math.max(this.cx,-2*s),this.cx=Math.min(this.cx,this.virtual_map_width-(this.width/this.scale-2*s)),this.cy=Math.max(this.cy,-s),this.cy=Math.min(this.cy,this.virtual_map_height-(this.height/this.scale-s)))}append_player(){let t=Math.random()*this.virtual_map_width,e=Math.random()*this.virtual_map_height;this.players.push(new P(this,t,e,.05*this.height/this.scale,this.get_random_color(),.3*this.height/this.scale,"robot"));const s=this.store.state.score+1;this.store.commit("updateScore",s),this.store.commit("updateRecord",s),console.log("[score]:",this.store.state.score,"[record]:",this.store.state.record)}get_random_color(){let t=["red","pink","grey","green","lightblue","lightgreen","yellow","orange","gold"];return t[Math.floor(Math.random()*t.length)]}update_score(){console.log("update score: ",this.store.state.score),U().ajax({url:"https://app4689.acapp.acwing.com.cn:4436/update_score/",type:"post",data:{rank_score:this.store.state.score,game_mode:this.store.state.game_mode},headers:{Authorization:"Bearer "+J.Z.get("access")}})}is_element_out_of_screen(t,e){return t<-.2*this.width/this.scale||t>1.2*this.width/this.scale||e<-.2*this.height/this.scale||e>1.2*this.height/this.scale}hide(){while(this.players&&this.players.length>0)this.players[0].destroy();while(this.fireballs&&this.fireballs.length>0)this.fireballs[0].destroy();this.game_map&&(this.game_map.destroy(),this.game_map=null),this.notice_board&&(this.notice_board.destroy(),this.notice_board=null),this.score_board&&(this.score_board.destroy(),this.score_board=null),console.log("playground hide DONE")}show_select_mode(){this.hide(),Y.Z.push("/select_mode"),this.destroy()}update(){this.focus_player&&(this.ctx_x=this.focus_player.x,this.ctx_y=this.focus_player.y),this.render()}render(){}}var G=s(65),V=(s(3389),s(9242));const K={class:"chatfield"},Q={class:"ac-game-chat-field-history",ref:"chat_field_history_ref"},tt={type:"text",ref:"chat_field_input_ref",class:"ac-game-chat-field-input"};function et(t,e,s,a,h,l){return(0,i.wg)(),(0,i.iD)("div",K,[(0,i.wy)((0,i._)("div",Q,null,512),[[V.F8,t.$store.state.show_history]]),(0,i.wy)((0,i._)("input",tt,null,512),[[V.F8,t.$store.state.chatting]])])}s(5654);var st={name:"ChatField",components:{},props:{},setup:t=>{(0,G.oR)();let e=(0,o.ref)(null),s=(0,o.ref)(null);return(0,i.bv)((()=>{})),{chat_field_input_ref:e,chat_field_history_ref:s}},methods:{}},it=s(89);const at=(0,it.Z)(st,[["render",et],["__scopeId","data-v-383cf32c"]]);var ht=at,lt={namespaced:!0,name:"PlayGround",components:{ChatField:ht},setup:()=>{let t=(0,o.ref)(null),e=(0,o.ref)(null),s=(0,o.ref)(null),a=(0,o.ref)(null),h={message:"let playground"};const l=(0,G.oR)();(0,i.bv)((()=>{a.value.addEventListener("mouseleave",(function(){e.value.focus(),console.log("鼠标移出按钮")})),console.log(l.state.game_mode),"no mode"!==l.state.game_mode?(h=new $(e,e.value.getContext("2d"),t.value,l,s.value),h.restart(l.state.game_mode)):Y.Z.push("/select_mode")}));const r=()=>{h.quit()};return{div:t,canvas:e,quit_the_game:r,chat_field_ref:s,quit_game_button:a}}};const rt=(0,it.Z)(lt,[["render",r],["__scopeId","data-v-1fc98392"]]);var ot=rt},680:function(t,e){
/*! js-cookie v3.0.1 | MIT */
function s(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var i in s)t[i]=s[i]}return t}var i={read:function(t){return'"'===t[0]&&(t=t.slice(1,-1)),t.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(t){return encodeURIComponent(t).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function a(t,e){function i(i,a,h){if("undefined"!==typeof document){h=s({},e,h),"number"===typeof h.expires&&(h.expires=new Date(Date.now()+864e5*h.expires)),h.expires&&(h.expires=h.expires.toUTCString()),i=encodeURIComponent(i).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var l="";for(var r in h)h[r]&&(l+="; "+r,!0!==h[r]&&(l+="="+h[r].split(";")[0]));return document.cookie=i+"="+t.write(a,i)+l}}function h(e){if("undefined"!==typeof document&&(!arguments.length||e)){for(var s=document.cookie?document.cookie.split("; "):[],i={},a=0;a<s.length;a++){var h=s[a].split("="),l=h.slice(1).join("=");try{var r=decodeURIComponent(h[0]);if(i[r]=t.read(l,r),e===r)break}catch(o){}}return e?i[e]:i}}return Object.create({set:i,get:h,remove:function(t,e){i(t,"",s({},e,{expires:-1}))},withAttributes:function(t){return a(this.converter,s({},this.attributes,t))},withConverter:function(t){return a(s({},this.converter,t),this.attributes)}},{attributes:{value:Object.freeze(e)},converter:{value:Object.freeze(t)}})}var h=a(i,{path:"/"});e["Z"]=h}}]);
//# sourceMappingURL=248.92a17755.js.map